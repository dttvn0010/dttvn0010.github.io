<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">

<div class="container">
	<div class="mt-3">
		<div class="row">
			<div class="col-4">
				<form id="fmt">
					<label>Audio wav file (8 Khz)</label>
					<input name="file" class="form-control-file" type="file">				
					<button type="button" class="mt-3 btn btn-primary" onclick="upload()">Upload</button>
				</form>
			</div>
			<div id="audio_tab" class="col-6">		
			</div>
		</div>
	</div>
</div>

<script>
	var uploading = false;
	var TEST_URL = "http://35.226.138.244:5000/test";
	var UPLOAD_URL = "http://35.226.138.244:5000/upload";
	
	function fetchTimeOut(url, options, timeout) {
		return Promise.race([
			fetch(url, options),
			new Promise((_, reject) =>
				setTimeout(() => reject(new Error('timeout')), timeout)
			)
		]);
	}

	async function upload() {
		if(uploading) { alert('Please wait...'); return; }
		uploading = true;
		
		document.getElementById('audio_tab').innerHTML = `<div style="position: absolute;left: 0%;top:30%" class="spinner-border"></div>`;
		
		var formData = new FormData(document.getElementById("fmt"));
		
		try {
			await fetchTimeOut(TEST_URL, {}, 3000);
		}catch(err) {
			alert("Server is turned off, please ask admin to turn server on");
			document.getElementById('audio_tab').innerHTML = "";
			uploading = false;
			return;
		}
		
		var resp = await fetchTimeOut(UPLOAD_URL, {
				body: formData,
				method: "POST"
			}, 100000);

		var result = await resp.json();
		
		var low_url = result.low_url;
		var high_url = result.high_url;
		
		var html = `<label>8Khz audio</label><br>
		<audio controls>
		  <source src="${low_url}" type="audio/wav">
		</audio>
		
		<br><br>
		<label>Super resolution audio (16Khz)</label><br>
		<audio controls>
		  <source src="${high_url}" type="audio/wav">
		</audio>`;
		
		document.getElementById('audio_tab').innerHTML = html;
		uploading = false;
	}
</script>
